# DB_MVCC

 `MVCC`는 `Multi Version Concurrency Control`의 줄임말로 다중 버전 동시성 제어라는 이름을 가진다. `Lock`을 쓰지 않고 동시성을 제어하는 다른 방법입니다.

### 1) 동시성 제어

 동시성 제어란 DBMS가 다수의 사용자 사이에서 동시에 작용하는 다중 트랜잭션의 상호간섭 작용에서 Database를 보호하는 것을 의미한다.

- 비관성 동시성 제어
  - 사용자들이 같은 데이터를 동시에 수정할 것이라고 가정
  - 데이터를 읽는 시점에 Lock을 걸고, 트랜젝션이 완료될 때까지 이를 유지
  - 시스템 성능상 좋지 않다.
- 낙관정 동시성 제어
  - 사용자들이 같은 데이터를 동시에 수정하지 않을 것이라고 가정
  - 데이터를 수정하는 시점에 값이 변경됐는지를 검사하는 방법

<br>

### 2) Locking 의 문제점

 동시성 제어의 목표는 동시에 실행되는 트랜젝션 수를 최대화하고 데이터의 무결성을 유지하는데 있습니다. 일반적인 `Lock`을 이용한 방법은 다음과 같은 문제가 있습니다.

- 읽기 작업과 쓰기 작업이 서로 방해를 일으킨다.
- 데이터 일관성에 문제가 생기는 경우는 `Lock`을 더 오래 유지하거나 테이블 레벨 `Lock`을 사용해야되므로 동시성 저하가 발생합니다.

<br>

### 3) MVCC

 MVCC는 동시 접근을 허용하는 데이터베이스에서 동시성을 제어하기 위해 사용하는 방법 중 하나이다. MVCC 모델에서 데이터에 접근하는 사용자는 접근한 시점에서 데이터베이스의 Snapshot을 읽는다. 이 snapshot 데이터에 대한 변경이 완료될 때 (트랜잭션이 commit 될 때) 까지 만들어진 변경사항은 다른 데이터베이스 사용자가 볼 수 없다. 이제 사용자가 데이터를 업데이트하면 이전의 데이터를 덮어 씌우는게 아니라 새로운 버전의 데이터를 UNDO 영역에 생성한다. 대신 이전 버전의 데이터와 비교해서 변경된 내용을 기록한다. 이렇게 해서 하나의 데이터에 대해 여러 버전의 데이터가 존재하게 되고, 사용자는 마지막 버전의 데이터를 읽게 된다.

- Lock을 이용하지 않으므로, 일반적인 RDBMS보다 빠르다
- 사용하지 않는 버전이 계속 쌓이게 되므로 데이터를 정리하는 시스템이 필요하다
- 데이터 버전이 충돌하면 애플리케이션 영역에서 문제를 해결해야한다.

<br>

### 4) MVCC 버전 충돌

 MVCC 에서 버전이 충돌하면 애플리케이션 영역에서 문제를 해결해야합니다. 보통 `Git`의 버전 충돌과 같은 메커니즘으로 동작한다.

```sql
A 트랜젝션에서 1번 사원의 정보를 select --> version 1.0
B 트랜젝션에서 1번 사원의 정보를 select --> version 1.0
A 트랜젝션에서 1번 사원의 정보를 새롭게 update & commit --> version 1.1
B 트랜젝션에서 1번 사원의 정보를 새롭게 update & commit --> version 1.2 ( 이때, 버전 충돌 발생 )
```

 위의 예시처럼 버전 충돌이 발생하면 DBMS는 `Version`의 시점을 알고 있으므로 충돌이 발생해 작업을 완료할 수 없다고 B트랜젝션을 사용 중인 사용자에게 알려줍니다. 그러면, 사용자가 충돌이 발생한 부분을 처리해주면 됩니다.

<br>